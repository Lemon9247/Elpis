# Session Report: Psyche Tool Behavior and Infrastructure Fixes

**Date:** 2026-01-14
**Duration:** ~1 hour
**Commits:** 5 (8667c05, da7eaf8, b503154, e685da8)

## Summary

Fixed multiple issues with Psyche's tool usage behavior and infrastructure problems preventing proper installation and TUI operation.

## Issues Addressed

### 1. Python 3.14 Compatibility (pyproject.toml)

**Problem:** User on Arch Linux had Python 3.14.2 which broke pip install due to missing wheels for many packages (chromadb, etc.).

**Solution:**
- Recommended using `uv` to manage Python versions
- Created new venv with Python 3.12 via `uv venv --python 3.12 venv`
- Simplified pyproject.toml: moved llama-cpp-python and transformers from optional extras to core dependencies
- Removed empty cuda/rocm extras (hints remain in README)

**Commit:** `8667c05` - Simplify pyproject.toml: make inference backends required

### 2. Psyche Using Tools Unprompted

**Problem:** Psyche would randomly start using tools at conversation start, even for simple greetings.

**Root Cause:** System prompt heavily emphasized tools with examples upfront, priming the LLM to use them.

**Solution:** Rewrote system prompt to:
- Emphasize conversational responses first
- Explicitly state "Only use tools when the user explicitly asks"
- Move tool documentation to reference section at end
- Add guideline "tools are a last resort"

**Commit:** `da7eaf8` - Fix Psyche using tools unprompted and ignoring user input

### 3. Psyche Ignoring User Input During Tool Execution

**Problem:** During ReAct tool loop, user input was ignored until all iterations completed.

**Solution:** Added input queue check at start of each ReAct iteration:
```python
if not self._input_queue.empty():
    logger.debug("New user input detected, breaking ReAct loop")
    return
```

**Commit:** `da7eaf8` (same as above)

### 4. Mnemosyne Logs Breaking TUI

**Problem:** Mnemosyne server logs to stderr, which breaks Textual TUI display.

**Solution:**
- Added `MNEMOSYNE_QUIET` env var support in `mnemosyne/cli.py`
- When set, logs redirect to `~/.mnemosyne/mnemosyne-server.log`
- Updated `MnemosyneClient` to pass `quiet=True` by default (matching `ElpisClient`)

**Commit:** `b503154` - Fix Mnemosyne logging breaking TUI and asyncio.gather exception handling

### 5. asyncio.gather Exception Handling

**Problem:** In `tool_engine.py`, `asyncio.gather(..., return_exceptions=False)` caused all concurrent tools to fail if any single one failed.

**Solution:** Changed to `return_exceptions=True` so failed tools don't cancel others.

**Commit:** `b503154` (same as above)

### 6. Psyche Hallucinating Tool Outputs

**Problem:** Psyche would fabricate/imagine what tools would return instead of waiting for actual results.

**Solution:** Added explicit instructions in system prompt:
- "After writing a tool_call block, you MUST stop immediately"
- "Do not write anything after the closing ```"
- "Do not guess or imagine what the tool will return"
- "NEVER fabricate or imagine tool outputs - wait for the real result"

**Commit:** `e685da8` - Fix Psyche hallucinating tool outputs

## Files Modified

- `pyproject.toml` - Simplified dependencies
- `src/psyche/memory/server.py` - System prompt rewrites, ReAct loop input check
- `src/psyche/mcp/client.py` - MnemosyneClient quiet parameter
- `src/psyche/tools/tool_engine.py` - asyncio.gather fix
- `src/mnemosyne/cli.py` - Logging configuration with quiet mode

## Testing

All relevant tests pass (203 psyche/memory/tool tests, 52 mnemosyne tests).

## Notes

- User is using `uv` for package management going forward
- uv venvs don't include pip by default - use `uv pip` instead
- Psyche tool behavior improvements need real-world testing to verify effectiveness
